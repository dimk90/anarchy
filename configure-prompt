#!/bin/bash

# Treat unset variables as an error and exit immediately
set -o nounset


## Imports


set -o errexit # exit on non-zero exit code

COMMON=$(curl -fsSL "https://dimk90.github.io/anarchy/common")
# shellcheck source=common
source <(echo "$COMMON")

set +o errexit # disable exit on non-zero exit code


## Const


FISH_CONFIG_SELECTOR=$(cat << 'EOF'
function select_starship_config
    # Check if we're in the native Linux terminal
    if test "$TERM" = "linux"
        # Use simple text-based config for Linux console
        set -gx STARSHIP_CONFIG ~/.config/starship/fallback.toml
    else
        # Use nerd font config for modern terminals
        set -gx STARSHIP_CONFIG ~/.config/starship/starship.toml
    end
end
EOF
)

BASH_CONFIG_SELECTOR=$(cat << 'EOF'
select_starship_config() {
    # Check if we're in the native Linux terminal
    if [ "$TERM" = "linux" ]; then
        # Use simple text-based config for Linux console
        export STARSHIP_CONFIG=~/.config/starship/fallback.toml
    else
        # Use selected theme for modern terminals
        export STARSHIP_CONFIG=~/.config/starship/starship.toml
    fi
}
EOF
)


## Runtime


# shellcheck disable=SC2329
fish_configure_highlighting() {
    # ANSI color codes:
    # https://hexdocs.pm/color_palette/ansi_color_codes.html

    # Hide fish greeting
    fish -c "set -U fish_greeting ''"

    # Set the emoji width (iTerm only?)
    fish -c "set -U fish_emoji_width 2"

    # Syntax highlighting
    # https://fishshell.com/docs/current/interactive.html#syntax-highlighting-variables
    fish -c "set -U fish_color_normal AAA"
    fish -c "set -U fish_color_command blue --bold"
    fish -c "set -U fish_color_operator 0FB"        # ( ), { }, ... # brwhite --bold ?
    fish -c "set -U fish_color_param normal"        # Disable highlighting
    fish -c "set -U fish_color_autosuggestion 444"
    fish -c "set -U fish_color_comment 464 --italic"
    fish -c "set -U fish_color_quote BE7"           # "Text"
    fish -c "set -U fish_color_escape 9EC"          # "...\n"
    fish -c "set -U fish_color_valid_path --underline"
    fish -c "set -U fish_color_error D55"
    fish -c "set -U fish_color_end FD6"             # Separators like ; and &
    fish -c "set -U fish_color_redirection FD6"     # Like >/dev/null
    fish -c "set -U fish_color_history_current --bold"
    fish -c "set -U fish_color_search_match normal" # Disable highlighting

    # Pager
    # https://fishshell.com/docs/current/interactive.html#pager-color-variables
    fish -c "set -U fish_pager_color_prefix brwhite --bold"
    fish -c "set -U fish_pager_color_selected_prefix black"
    fish -c "set -U fish_pager_color_completion normal"
    fish -c "set -U fish_pager_color_selected_completion black"
    fish -c "set -U fish_pager_color_description 555"
    fish -c "set -U fish_pager_color_selected_description black"
    fish -c "set -U fish_pager_color_selected_background --background=AFA"
    fish -c "set -U fish_pager_color_progress black --background=7FF"
}


# shellcheck disable=SC2329
fish_enable_starship() {
    # Add starship config selector function
    echo "${FISH_CONFIG_SELECTOR}" > ~/.config/fish/functions/select_starship_config.fish
    assert $? 'failed to add starship config selector function'

    # Remove old starship init to guarantee select_starship_config call before init
    remove_line ~/.config/fish/config.fish 'starship init fish \| source'
    assert $? 'failed to remove old starship init'

    # Add starship init with config selector
    config_set_param ~/.config/fish/config.fish \
        'select_starship_config; starship init fish \| source'
    assert $? 'failed to add starship init with config selector'
}


# shellcheck disable=SC2329
bash_enable_starship() {
    # Remove old starship init to guarantee select_starship_config call before init
    remove_line ~/.bashrc 'starship init bash'
    assert $? 'failed to remove old starship init'

    # Add config selector function to .bashrc
    if ! grep -q 'select_starship_config' ~/.bashrc; then
        { echo; echo "${BASH_CONFIG_SELECTOR}"; echo; } >> ~/.bashrc
        assert $? 'failed to add starship config selector function'
    fi

    # Add starship init with config selector
    config_set_param ~/.bashrc \
        'select_starship_config && eval "\$\(starship init bash\)"'
    assert $? 'failed to add starship init with config selector'
}


main() {

    ## Get gum

    request_gum
    assert $? 'no gum - no fun :('

    ## Init

    printf_section "Starting\n"
    printf_action "Common lib version: ${STYLE_CLR}${COMMON_VERSION}\n"
    start_logger
    printf_action "Log started: ${STYLE_CLR}${LOG_FILE}\n"

    ## Starship

    printf_section "Starship\n"
    action_require_package 'starship'

    # Create starship dir for configs
    mkdir -p ~/.config/starship
    assert $? 'failed to create starship config directory'

    # Download fallback theme
    printf_action "Fallback theme: ${STYLE_CLR}pure-text\n"
    action_install_file ~/.config/starship/fallback.toml \
        "https://dimk90.github.io/anarchy/starship/starship.pure-text.toml"

    # Select & download starship theme
    local header
    header=$(prefix_printf "$(bullet_action)" 'Select starship theme:\n')

    local choice
    if choice=$(gum choose --cursor="      > "  \
                           --header="${header}" \
                           --limit=1            \
                           'pure' 'capsule' 'pure-text'); then
        printf_action "Starship theme: ${STYLE_CLR}${choice}\n"
        action_install_file ~/.config/starship/starship.toml \
            "https://dimk90.github.io/anarchy/starship/starship.${choice}.toml"
    fi

    ## Fish

    if is_command_available 'fish'; then
        printf_section "Configure fish\n"

        export -f fish_configure_highlighting
        action_run 'Configure syntax highlighting' 'fish_configure_highlighting' 'done'

        export FISH_CONFIG_SELECTOR
        export -f fish_enable_starship
        action_run 'Enable starship' 'fish_enable_starship' 'done'
    fi

    ## Bash

    if is_command_available 'bash'; then
        printf_section "Configure bash\n"

        export BASH_CONFIG_SELECTOR
        export -f bash_enable_starship
        action_run 'Enable starship' 'bash_enable_starship' 'done'
    fi

    return 0
}


# Run main and return its exit code
main "$@"
exit $?
