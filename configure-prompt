#!/bin/bash

# Treat unset variables as an error and exit immediately
set -o nounset


## Imports


set -o errexit # exit on non-zero exit code

COMMON=$(curl -fsSL "https://dimk90.github.io/anarchy/common")
# shellcheck source=common
source <(echo "$COMMON")

set +o errexit # disable exit on non-zero exit code


## Runtime


fish_configure_highlighting() {
    # Hide fish greeting
    fish -c "set -U fish_greeting ''"

    # Set the emoji width (iTerm only?)
    fish -c "set -U fish_emoji_width 2"

    # Syntax highlighting
    # https://fishshell.com/docs/current/interactive.html#syntax-highlighting-variables
    fish -c "set -U fish_color_normal AAA"
    fish -c "set -U fish_color_command blue --bold"
    fish -c "set -U fish_color_operator 0FB"        # ( ), { }, ... # brwhite --bold ?
    fish -c "set -U fish_color_param normal"        # Disable highlighting
    fish -c "set -U fish_color_autosuggestion 444"
    fish -c "set -U fish_color_comment 464 --italic"
    fish -c "set -U fish_color_quote BE7"           # "Text"
    fish -c "set -U fish_color_escape 9EC"          # "...\n"
    fish -c "set -U fish_color_valid_path --underline"
    fish -c "set -U fish_color_error D55"
    fish -c "set -U fish_color_end FD6"             # Separators like ; and &
    fish -c "set -U fish_color_redirection FD6"     # Like >/dev/null
    fish -c "set -U fish_color_history_current --bold"
    fish -c "set -U fish_color_search_match normal" # Disable highlighting

    # Pager
    # https://fishshell.com/docs/current/interactive.html#pager-color-variables
    fish -c "set -U fish_pager_color_prefix brwhite --bold"
    fish -c "set -U fish_pager_color_selected_prefix black"
    fish -c "set -U fish_pager_color_completion normal"
    fish -c "set -U fish_pager_color_selected_completion black"
    fish -c "set -U fish_pager_color_description 555"
    fish -c "set -U fish_pager_color_selected_description black"
    fish -c "set -U fish_pager_color_selected_background --background=AFA"
    fish -c "set -U fish_pager_color_progress black --background=7FF"
}


main() {

    ## Get gum

    request_gum
    assert $? 'no gum - no fun :('

    ## Init

    printf_section "Starting\n"
    printf_action "Common lib version: ${STYLE_CLR}${COMMON_VERSION}\n"
    start_logger
    printf_action "Log started: ${STYLE_CLR}${LOG_FILE}\n"

    ## Starship

    printf_section "Starship\n"
    action_require_package 'starship'

    # Select starship theme
    local header=$(prefix_printf "$(bullet_action)" 'Select starship theme:\n')
    local choice
    choice=$(gum choose --cursor="      > " --header="${header}" \
                        --limit=1 'pure' 'capsule' 'pure-text')
    if [ $? -eq 0 ]; then
        printf_action "Starship theme: ${STYLE_CLR}${choice}\n"
        action_install_file ~/.config/starship.toml \
            "https://dimk90.github.io/anarchy/starship/starship.${choice}.toml"
    fi

    ## Fish

    if is_command_available 'fish'; then
        printf_section "Configure fish\n"

        export -f fish_configure_highlighting
        action_run 'Configure syntax highlighting' 'fish_configure_highlighting' 'done'

        local fish_starship_init='starship init fish \| source'
        action_run 'Enable starship' \
            "config_set_param ~/.config/fish/config.fish '${fish_starship_init}'" 'done'
    fi

    ## Bash

    if is_command_available 'bash'; then
        printf_section "Configure bash\n"
        # shellcheck disable=SC2016
        local bash_starship_init='eval "\$\(starship init bash\)"'
        action_run 'Enable starship' \
            "config_set_param ~/.bashrc '${bash_starship_init}'" 'done'
    fi

    return 0
}


# Run main and return its exit code
main "$@"
exit $?
