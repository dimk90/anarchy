#!/bin/bash

# Treat unset variables as an error and exit immediately
set -o nounset


## Imports


set -o errexit # exit on non-zero exit code

COMMON=$(curl -fsSL "https://dimk90.github.io/anarchy/common")
# shellcheck source=common
source <(echo "$COMMON")

set +o errexit # disable exit on non-zero exit code


## Routines


main() {

    ## Get gum

    request_gum
    assert $? 'no gum - no fun :('

    ## Init

    printf_section "Starting\n"
    printf_action "Common lib version: ${STYLE_CLR}${COMMON_VERSION}\n"
    start_logger
    printf_action "Log started: ${STYLE_CLR}${LOG_FILE}\n"

    ## Ask user for items to install

    printf_section "Confirm Items\n"

    local choices
    choices=$(gum choose --no-limit --selected='*' \
                         --header "Select items to install:" \
                         'Settings' \
                         'Keybindings' \
                         'Set as default editor')
    # shellcheck disable=SC2181
    [ $? -ne 0 ] && return 0 # cancelled by user
    mapfile -t choices <<< "$choices" # Convert choices string to array
    printf_action "Selected items: ${STYLE_CLR}${#choices[@]}\n"

    # Empty choice means nothing to do -> exit
    if [ ${#choices[@]} -eq 0 ]; then
        echo
        return 0
    fi

    ## Install micro

    printf_section "Installing & Configuring\n"

    action_require_package 'micro'

    # Create micro config directory if it doesn't exist
    mkdir -p ~/.config/micro
    assert $? "can't create ~/.config/micro"

    ## Install selected items

    local shells
    for choice in "${choices[@]}"; do
        case "${choice,,}" in
            settings*)
                action_install_file "${HOME}/.config/micro/settings.json"  \
                    'https://dimk90.github.io/anarchy/micro/settings.json'
                # Replace obsolete MICRO_TRUECOLOR with truecolor=auto in settings (since 2.0.15)
                shells="$(env_unset_permanent 'MICRO_TRUECOLOR')"
                [ -n "$shells" ] && action_run "Remove MICRO_TRUECOLOR (in favor to settings) for ${STYLE_CLR}${STYLE_BOLD}$shells"
                ;;
            keybindings*)
                action_install_file "${HOME}/.config/micro/bindings.json"  \
                    'https://dimk90.github.io/anarchy/micro/bindings.json'
                ;;
            *editor*)
                shells="$(env_set_permanent 'EDITOR' 'micro')"
                [ -n "$shells" ] && action_run "Set EDITOR to micro for ${STYLE_CLR}${STYLE_BOLD}$shells"
                ;;
            *) assert 1 "invalid choice: ${choice}"
                ;;
        esac
    done

    echo
    return 0
}


# Run main and return its exit code
main "$@"
exit $?
